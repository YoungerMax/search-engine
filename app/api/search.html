<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Search</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #F7F4EF;
    --ink: #1A1714;
    --muted: #7A756E;
    --accent: #C4462A;
    --card-bg: #FFFFFF;
    --border: #E2DDD6;
    --hover: #F0EBE4;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--ink);
    min-height: 100vh;
  }

  /* ── HOME STATE ── */
  #home {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    padding: 2rem;
    transition: opacity 0.3s ease;
  }

  #home.hidden { display: none; }

  .home-wordmark {
    font-family: 'Playfair Display', serif;
    font-size: clamp(3rem, 10vw, 7rem);
    font-weight: 700;
    letter-spacing: -0.03em;
    line-height: 1;
    margin-bottom: 2.5rem;
    color: var(--ink);
    position: relative;
  }

  .home-wordmark span { color: var(--accent); }

  .home-tagline {
    font-size: 0.85rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 2rem;
    font-weight: 500;
  }

  /* ── SEARCH BOX ── */
  .search-wrapper {
    position: relative;
    width: 100%;
    max-width: 620px;
  }

  .search-wrapper input {
    width: 100%;
    padding: 1rem 3.5rem 1rem 1.4rem;
    font-family: 'DM Sans', sans-serif;
    font-size: 1.05rem;
    font-weight: 400;
    background: var(--card-bg);
    border: 1.5px solid var(--border);
    border-radius: 4px;
    color: var(--ink);
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  }

  .search-wrapper input:focus {
    border-color: var(--ink);
    box-shadow: 0 3px 14px rgba(0,0,0,0.10);
  }

  .search-wrapper input::placeholder { color: #B5B0A8; }

  .search-btn {
    position: absolute;
    right: 0.9rem;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    cursor: pointer;
    color: var(--muted);
    display: flex;
    align-items: center;
    transition: color 0.15s;
    padding: 0;
  }
  .search-btn:hover { color: var(--accent); }

  .home-hints {
    margin-top: 1.5rem;
    display: flex;
    gap: 0.6rem;
    flex-wrap: wrap;
    justify-content: center;
  }

  .hint-chip {
    font-size: 0.78rem;
    padding: 0.35rem 0.75rem;
    border: 1px solid var(--border);
    border-radius: 999px;
    background: var(--card-bg);
    color: var(--muted);
    cursor: pointer;
    transition: all 0.15s;
    user-select: none;
  }
  .hint-chip:hover {
    border-color: var(--ink);
    color: var(--ink);
    background: var(--hover);
  }

  /* ── RESULTS STATE ── */
  #results-page { display: none; }
  #results-page.visible { display: block; }

  /* TOP BAR */
  .topbar {
    background: var(--card-bg);
    border-bottom: 1px solid var(--border);
    padding: 0.75rem 1.5rem;
    display: flex;
    align-items: center;
    gap: 1.5rem;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 1px 6px rgba(0,0,0,0.05);
  }

  .topbar-logo {
    font-family: 'Playfair Display', serif;
    font-weight: 700;
    font-size: 1.4rem;
    color: var(--ink);
    cursor: pointer;
    white-space: nowrap;
    flex-shrink: 0;
    letter-spacing: -0.02em;
  }
  .topbar-logo span { color: var(--accent); }

  .topbar .search-wrapper { max-width: 520px; flex: 1; }
  .topbar .search-wrapper input { padding: 0.65rem 3rem 0.65rem 1rem; font-size: 0.97rem; }

  /* RESULTS BODY */
  .results-body {
    max-width: 760px;
    margin: 0 auto;
    padding: 1.8rem 1.5rem 4rem;
  }

  .results-meta {
    font-size: 0.8rem;
    color: var(--muted);
    letter-spacing: 0.04em;
    margin-bottom: 1.8rem;
    font-weight: 500;
    text-transform: uppercase;
  }

  .results-meta strong {
    color: var(--ink);
    font-weight: 600;
  }
  .spellcheck-meta {
    margin-top: -1rem;
    margin-bottom: 1.2rem;
    font-size: 0.9rem;
    color: var(--muted);
  }
  .spellcheck-link {
    border: none;
    background: none;
    color: var(--accent);
    font: inherit;
    padding: 0;
    cursor: pointer;
    text-decoration: underline;
    text-underline-offset: 2px;
  }

  /* RESULT CARD */
  .result-card {
    margin-bottom: 0.25rem;
    padding: 1.1rem 1.2rem;
    border-radius: 3px;
    background: transparent;
    transition: background 0.15s;
    cursor: pointer;
    border-left: 3px solid transparent;
    text-decoration: none;
    display: block;
    color: inherit;
  }

  .result-card:hover {
    background: var(--card-bg);
    border-left-color: var(--accent);
    box-shadow: 0 2px 12px rgba(0,0,0,0.07);
  }

  .result-url {
    font-size: 0.75rem;
    color: var(--muted);
    letter-spacing: 0.02em;
    margin-bottom: 0.3rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    font-weight: 400;
  }

  .result-title {
    font-family: 'Playfair Display', serif;
    font-size: 1.05rem;
    font-weight: 700;
    color: var(--ink);
    margin-bottom: 0.3rem;
    line-height: 1.35;
  }

  .result-card:hover .result-title { color: var(--accent); }

  .result-description {
    font-size: 0.88rem;
    color: #5A554F;
    line-height: 1.6;
    font-weight: 300;
  }

  .result-score {
    margin-top: 0.4rem;
    font-size: 0.7rem;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    color: #B5B0A8;
    font-weight: 500;
  }

  .result-divider {
    height: 1px;
    background: var(--border);
    margin: 0 1.2rem;
    opacity: 0.5;
  }

  /* PAGINATION */
  .pagination {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 2.5rem;
  }

  .page-btn {
    padding: 0.5rem 1rem;
    border: 1.5px solid var(--border);
    border-radius: 3px;
    background: var(--card-bg);
    font-family: 'DM Sans', sans-serif;
    font-size: 0.85rem;
    font-weight: 500;
    color: var(--ink);
    cursor: pointer;
    transition: all 0.15s;
  }
  .page-btn:hover:not(:disabled) {
    border-color: var(--ink);
    background: var(--hover);
  }
  .page-btn:disabled {
    color: var(--muted);
    opacity: 0.5;
    cursor: default;
  }
  .page-info {
    font-size: 0.82rem;
    color: var(--muted);
    padding: 0 0.5rem;
  }

  /* STATES */
  .state-box {
    text-align: center;
    padding: 4rem 2rem;
    color: var(--muted);
  }
  .state-box .state-icon {
    font-size: 2.5rem;
    margin-bottom: 1rem;
    opacity: 0.4;
  }
  .state-box p {
    font-size: 0.95rem;
    font-weight: 400;
  }
  .state-box strong { color: var(--ink); font-weight: 600; }

  /* SPINNER */
  .spinner {
    width: 22px; height: 22px;
    border: 2.5px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
    margin: 3rem auto;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* FADE IN for results */
  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .result-card { animation: fadeUp 0.25s ease both; }
</style>
</head>
<body>

<!-- HOME -->
<div id="home">
  <div class="home-wordmark">Search<span>.</span></div>
  <p class="home-tagline">Find what matters</p>
  <div class="search-wrapper">
    <input type="text" id="home-input" placeholder="What are you looking for?" autocomplete="off" />
    <button class="search-btn" onclick="doSearch()">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
    </button>
  </div>
  <div class="home-hints">
    <span class="hint-chip" onclick="fillAndSearch('New York Times')">New York Times</span>
    <span class="hint-chip" onclick="fillAndSearch('privacy policy')">privacy policy</span>
    <span class="hint-chip" onclick="fillAndSearch('advertising')">advertising</span>
    <span class="hint-chip" onclick="fillAndSearch('terms of sale')">terms of sale</span>
  </div>
</div>

<!-- RESULTS PAGE -->
<div id="results-page">
  <div class="topbar">
    <div class="topbar-logo" onclick="goHome()">Search<span>.</span></div>
    <div class="search-wrapper">
      <input type="text" id="results-input" placeholder="Search..." autocomplete="off" />
      <button class="search-btn" onclick="doSearch()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      </button>
    </div>
  </div>
  <div class="results-body">
    <div id="results-meta" class="results-meta"></div>
    <div id="spellcheck-meta" class="spellcheck-meta"></div>
    <div id="results-list"></div>
    <div id="pagination" class="pagination"></div>
  </div>
</div>

<script>
  const LIMIT = 20;
  let currentQuery = '';
  let currentOffset = 0;
  let currentTotal = 0;

  const homeEl = document.getElementById('home');
  const resultsPage = document.getElementById('results-page');
  const homeInput = document.getElementById('home-input');
  const resultsInput = document.getElementById('results-input');
  const resultsList = document.getElementById('results-list');
  const resultsMeta = document.getElementById('results-meta');
  const spellcheckMeta = document.getElementById('spellcheck-meta');
  const paginationEl = document.getElementById('pagination');

  homeInput.addEventListener('keydown', e => { if (e.key === 'Enter') doSearch(); });
  resultsInput.addEventListener('keydown', e => { if (e.key === 'Enter') doSearch(); });

  function getActiveInput() {
    return resultsPage.classList.contains('visible') ? resultsInput : homeInput;
  }

  function fillAndSearch(q) {
    homeInput.value = q;
    doSearch();
  }

  function doSearch(offset = 0) {
    const q = getActiveInput().value.trim();
    if (!q) return;
    currentQuery = q;
    currentOffset = offset;
    homeInput.value = q;
    resultsInput.value = q;
    showResultsPage();
    fetchResults(q, offset);
  }

  function showResultsPage() {
    homeEl.classList.add('hidden');
    resultsPage.classList.add('visible');
  }

  function goHome() {
    homeEl.classList.remove('hidden');
    resultsPage.classList.remove('visible');
    homeInput.value = '';
    resultsInput.value = '';
    homeInput.focus();
  }

  async function fetchResults(q, offset) {
    resultsMeta.textContent = '';
    spellcheckMeta.textContent = '';
    paginationEl.innerHTML = '';
    resultsList.innerHTML = '<div class="spinner"></div>';

    const searchUrl = `/search?q=${encodeURIComponent(q)}&limit=${LIMIT}&offset=${offset}`;
    const spellcheckUrl = `/spellcheck?q=${encodeURIComponent(q)}`;

    try {
      const [searchRes, spellcheckRes] = await Promise.all([
        fetch(searchUrl),
        fetch(spellcheckUrl),
      ]);
      if (!searchRes.ok) throw new Error(`HTTP ${searchRes.status}`);

      const searchData = await searchRes.json();
      let suggestion = null;
      if (spellcheckRes.ok) {
        const spellcheckData = await spellcheckRes.json();
        suggestion = spellcheckData.suggestion || null;
      }

      renderResults(searchData, q, offset, suggestion);
    } catch (err) {
      resultsList.innerHTML = `
        <div class="state-box">
          <div class="state-icon">⚡</div>
          <p>Could not connect to the search service.<br><strong>${err.message}</strong></p>
        </div>`;
    }
  }

  function renderResults(data, q, offset, suggestion) {
    const results = data.results || [];
    currentTotal = results.length; // no total count in API, use results.length

    if (suggestion && suggestion.toLowerCase() !== q.toLowerCase()) {
      spellcheckMeta.innerHTML = `Did you mean <button class="spellcheck-link" onclick="searchSuggestion('${escAttr(suggestion)}')">${escHtml(suggestion)}</button>?`;
    } else {
      spellcheckMeta.textContent = '';
    }

    if (results.length === 0) {
      resultsMeta.innerHTML = `No results for <strong>"${escHtml(q)}"</strong>`;
      resultsList.innerHTML = `
        <div class="state-box">
          <div class="state-icon">◎</div>
          <p>Nothing matched your search. Try different keywords.</p>
        </div>`;
      paginationEl.innerHTML = '';
      return;
    }

    resultsMeta.innerHTML = `<strong>${results.length}</strong> result${results.length !== 1 ? 's' : ''} for <strong>"${escHtml(q)}"</strong>`;

    resultsList.innerHTML = results.map((r, i) => {
      const delay = (i * 0.04).toFixed(2);
      const domain = getDomain(r.url);
      const scoreLabel = r.score != null ? `<div class="result-score">Relevance · ${r.score.toFixed(1)}</div>` : '';
      return `
        <a class="result-card" href="${escHtml(r.url)}" target="_blank" rel="noopener" style="animation-delay:${delay}s">
          <div class="result-url">${escHtml(domain)} · ${escHtml(r.url)}</div>
          <div class="result-title">${escHtml(r.title || 'Untitled')}</div>
          <div class="result-description">${escHtml(r.description || '')}</div>
          ${scoreLabel}
        </a>
        ${i < results.length - 1 ? '<div class="result-divider"></div>' : ''}
      `;
    }).join('');

    // Pagination (prev / next) based on whether we got LIMIT results
    const page = Math.floor(offset / LIMIT) + 1;
    const hasMore = results.length === LIMIT;
    const hasPrev = offset > 0;

    if (hasPrev || hasMore) {
      paginationEl.innerHTML = `
        <button class="page-btn" onclick="doSearch(${offset - LIMIT})" ${hasPrev ? '' : 'disabled'}>← Previous</button>
        <span class="page-info">Page ${page}</span>
        <button class="page-btn" onclick="doSearch(${offset + LIMIT})" ${hasMore ? '' : 'disabled'}>Next →</button>
      `;
    }
  }

  function getDomain(url) {
    try { return new URL(url).hostname.replace('www.', ''); } catch { return url; }
  }

  function searchSuggestion(q) {
    homeInput.value = q;
    resultsInput.value = q;
    doSearch(0);
  }

  function escHtml(str) {
    if (!str) return '';
    return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  function escAttr(str) {
    if (!str) return '';
    return str.replace(/\\/g, '\\\\').replace(/'/g, "\\'");
  }
</script>
</body>
</html>
