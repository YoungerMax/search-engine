<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Feed</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;0,900;1,400&family=DM+Mono:wght@300;400&family=Lora:ital@0;1&display=swap" rel="stylesheet">
<style>
  :root {
    --ink: #1a1208;
    --paper: #f5f0e8;
    --cream: #ede6d5;
    --rule: #c8bfa8;
    --accent: #b5290e;
    --muted: #7a6e5f;
    --highlight: #f0e6c8;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--paper);
    color: var(--ink);
    font-family: 'Lora', Georgia, serif;
    min-height: 100vh;
  }

  /* Masthead */
  header {
    border-bottom: 3px double var(--ink);
    padding: 1.5rem 2rem 1rem;
    text-align: center;
    position: relative;
  }

  header::before {
    content: '';
    display: block;
    border-top: 1px solid var(--ink);
    margin-bottom: 0.75rem;
  }

  .masthead-date {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 0.4rem;
  }

  .masthead-title {
    font-family: 'Playfair Display', serif;
    font-size: clamp(2.5rem, 6vw, 5rem);
    font-weight: 900;
    letter-spacing: -0.02em;
    line-height: 1;
    margin-bottom: 0.3rem;
  }

  .masthead-tagline {
    font-family: 'DM Mono', monospace;
    font-size: 0.6rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--muted);
  }

  /* Search bar */
  .search-wrap {
    border-bottom: 1px solid var(--rule);
    padding: 0.75rem 2rem;
    background: var(--cream);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.4rem;
  }

  .search-controls {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    width: 100%;
    max-width: 640px;
  }

  .search-label {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--muted);
    white-space: nowrap;
  }

  #search-input {
    flex: 1;
    border: none;
    background: transparent;
    border-bottom: 1px solid var(--ink);
    padding: 0.3rem 0;
    font-family: 'Playfair Display', serif;
    font-size: 1rem;
    color: var(--ink);
    outline: none;
  }

  #search-input::placeholder { color: var(--rule); font-style: italic; }

  .search-btn {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    background: var(--ink);
    color: var(--paper);
    border: none;
    padding: 0.45rem 1rem;
    cursor: pointer;
    transition: background 0.15s;
    white-space: nowrap;
  }
  .search-btn:hover { background: var(--accent); }

  .search-info {
    font-family: 'DM Mono', monospace;
    font-size: 0.6rem;
    color: var(--muted);
    white-space: nowrap;
    min-height: 1em;
  }

  /* Layout */
  main {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
  }

  /* Loading/error states */
  .state-msg {
    text-align: center;
    padding: 4rem 2rem;
    font-style: italic;
    color: var(--muted);
    font-size: 1.1rem;
  }

  .state-msg .mono {
    font-family: 'DM Mono', monospace;
    font-style: normal;
    font-size: 0.75rem;
    display: block;
    margin-top: 0.5rem;
    color: var(--rule);
  }

  /* Articles grid */
  #articles {
    display: grid;
    grid-template-columns: 1fr;
    gap: 0;
  }

  .article-card {
    border-bottom: 1px solid var(--rule);
    padding: 1.75rem 0;
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 1.5rem;
    align-items: start;
    cursor: pointer;
    transition: background 0.15s;
    animation: fadeIn 0.35s ease both;
  }

  .article-card:hover {
    background: var(--highlight);
    margin: 0 -2rem;
    padding-left: 2rem;
    padding-right: 2rem;
  }

  .article-card:first-child { border-top: 1px solid var(--rule); }

  /* Card thumbnail */
  .card-right {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 0.6rem;
  }

  .card-thumb {
    width: 120px;
    height: 80px;
    object-fit: cover;
    display: block;
    border: 1px solid var(--rule);
    background: var(--cream);
    flex-shrink: 0;
  }

  .card-feed-thumb {
    width: 120px;
    height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--cream);
    border: 1px solid var(--rule);
    flex-shrink: 0;
    padding: 0.6rem;
  }

  .card-feed-thumb img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    opacity: 0.65;
  }

  /* Modal hero image */
  .modal-image {
    width: 100%;
    max-height: 300px;
    object-fit: cover;
    display: block;
    border-bottom: 1px solid var(--rule);
  }

  /* Feed detail modal */
  #feed-modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(26,18,8,0.65);
    z-index: 200;
    backdrop-filter: blur(2px);
    animation: fadeOverlay 0.2s ease;
  }

  #feed-modal {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: min(480px, 92vw);
    background: var(--paper);
    z-index: 201;
    border-top: 4px solid var(--ink);
    animation: slideUp 0.25s ease;
  }

  .feed-modal-header {
    padding: 1.5rem 2rem 1.25rem;
    border-bottom: 1px solid var(--rule);
    display: flex;
    align-items: flex-start;
    gap: 1rem;
  }

  .feed-modal-logo {
    width: 52px;
    height: 52px;
    object-fit: contain;
    flex-shrink: 0;
    background: var(--cream);
    border: 1px solid var(--rule);
    padding: 4px;
  }

  .feed-modal-name {
    font-family: 'Playfair Display', serif;
    font-size: 1.3rem;
    font-weight: 700;
    line-height: 1.2;
    flex: 1;
  }

  .feed-modal-close {
    background: none;
    border: 1px solid var(--rule);
    color: var(--muted);
    font-family: 'DM Mono', monospace;
    font-size: 0.6rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    padding: 0.3rem 0.6rem;
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
    flex-shrink: 0;
  }
  .feed-modal-close:hover { background: var(--ink); color: var(--paper); border-color: var(--ink); }

  .feed-modal-body {
    padding: 1.25rem 2rem 1.75rem;
  }

  .feed-stat {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--cream);
    gap: 1rem;
  }

  .feed-stat:last-child { border-bottom: none; }

  .feed-stat-label {
    font-family: 'DM Mono', monospace;
    font-size: 0.6rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--muted);
    white-space: nowrap;
  }

  .feed-stat-value {
    font-family: 'Lora', serif;
    font-size: 0.88rem;
    color: var(--ink);
    text-align: right;
    word-break: break-all;
  }

  .feed-stat-value a {
    color: var(--accent);
    text-decoration: none;
  }
  .feed-stat-value a:hover { text-decoration: underline; }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(6px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .card-source {
    margin-bottom: 0.4rem;
  }

  .card-source-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    background: none;
    border: none;
    padding: 0;
    cursor: pointer;
    font-family: 'DM Mono', monospace;
    font-size: 0.6rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--accent);
    transition: color 0.15s;
  }
  .card-source-btn:hover { color: var(--ink); }

  .card-source-logo {
    width: 14px;
    height: 14px;
    object-fit: contain;
    flex-shrink: 0;
    opacity: 0.75;
  }

  .card-title {
    font-family: 'Playfair Display', serif;
    font-size: 1.25rem;
    font-weight: 700;
    line-height: 1.3;
    margin-bottom: 0.5rem;
    color: var(--ink);
  }

  .article-card:hover .card-title { text-decoration: underline; text-decoration-color: var(--accent); }

  .card-desc {
    font-size: 0.88rem;
    line-height: 1.6;
    color: var(--muted);
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .card-meta {
    font-family: 'DM Mono', monospace;
    font-size: 0.58rem;
    color: var(--rule);
    margin-top: 0.6rem;
    letter-spacing: 0.05em;
  }

  .card-date {
    font-family: 'DM Mono', monospace;
    font-size: 0.6rem;
    color: var(--muted);
    white-space: nowrap;
    letter-spacing: 0.05em;
    text-align: right;
  }


  /* Modal / article reader */
  #modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(26,18,8,0.65);
    z-index: 100;
    backdrop-filter: blur(2px);
    animation: fadeOverlay 0.2s ease;
  }

  @keyframes fadeOverlay { from { opacity: 0; } to { opacity: 1; } }

  #modal {
    position: fixed;
    top: 3vh;
    left: 50%;
    transform: translateX(-50%);
    width: min(720px, 95vw);
    max-height: 94vh;
    background: var(--paper);
    overflow-y: auto;
    z-index: 101;
    animation: slideUp 0.25s ease;
    border-top: 4px solid var(--ink);
  }

  @keyframes slideUp {
    from { opacity: 0; transform: translateX(-50%) translateY(20px); }
    to { opacity: 1; transform: translateX(-50%) translateY(0); }
  }

  .modal-header {
    padding: 2rem 2.5rem 1.5rem;
    border-bottom: 1px solid var(--rule);
    position: sticky;
    top: 0;
    background: var(--paper);
    z-index: 1;
  }

  .modal-source {
    margin-bottom: 0.6rem;
  }

  .modal-source-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    background: none;
    border: none;
    padding: 0;
    cursor: pointer;
    font-family: 'DM Mono', monospace;
    font-size: 0.6rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--accent);
    transition: color 0.15s;
  }
  .modal-source-btn:hover { color: var(--ink); }

  .modal-source-logo {
    width: 16px;
    height: 16px;
    object-fit: contain;
    flex-shrink: 0;
    opacity: 0.75;
  }

  .modal-title {
    font-family: 'Playfair Display', serif;
    font-size: 1.6rem;
    font-weight: 700;
    line-height: 1.25;
    margin-bottom: 0.75rem;
  }

  .modal-byline {
    font-family: 'DM Mono', monospace;
    font-size: 0.62rem;
    color: var(--muted);
    letter-spacing: 0.05em;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
  }

  .close-btn {
    background: none;
    border: 1px solid var(--rule);
    color: var(--muted);
    font-family: 'DM Mono', monospace;
    font-size: 0.6rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    padding: 0.35rem 0.75rem;
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
  }
  .close-btn:hover { background: var(--ink); color: var(--paper); border-color: var(--ink); }

  .modal-body {
    font-size: 0.95rem;
    line-height: 1.8;
    color: var(--ink);
  }

  .modal-content-body {
    padding: 1.75rem 2.5rem;
  }
  .modal-content-body:last-child { padding-bottom: 2.5rem; }

  .modal-body p { margin-bottom: 1em; }
  .modal-body a { color: var(--accent); }
  .modal-body img { max-width: 100%; margin: 1em 0; }

  .modal-link {
    display: block;
    width: fit-content;
    margin-top: 2rem;
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--paper) !important;
    background: var(--ink);
    padding: 0.6rem 1.2rem;
    text-decoration: none !important;
    transition: background 0.15s;
  }
  .modal-link:hover { background: var(--accent); }

  /* Pagination */
  #pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 1rem;
    padding: 2.5rem 0 1rem;
    border-top: 1px solid var(--rule);
    margin-top: 0.5rem;
  }

  .page-btn {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    background: none;
    border: 1px solid var(--ink);
    color: var(--ink);
    padding: 0.5rem 1.2rem;
    cursor: pointer;
    transition: all 0.15s;
  }
  .page-btn:hover:not(:disabled) { background: var(--ink); color: var(--paper); }
  .page-btn:disabled { opacity: 0.3; cursor: default; }

  .page-info {
    font-family: 'DM Mono', monospace;
    font-size: 0.62rem;
    color: var(--muted);
    letter-spacing: 0.08em;
  }

  /* Spinner */
  .spinner {
    width: 28px; height: 28px;
    border: 2px solid var(--rule);
    border-top-color: var(--ink);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin: 3rem auto;
    display: block;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>

<header>
  <div class="masthead-date" id="today-date"></div>
  <div class="masthead-title">The Feed</div>
  <div class="masthead-tagline">All the news that's fit to fetch</div>
</header>

<div class="search-wrap">
  <div class="search-controls">
    <span class="search-label">Search</span>
    <input type="text" id="search-input" placeholder="Keywords…" autocomplete="off">
    <button class="search-btn" onclick="doSearch()">Find</button>
  </div>
  <span class="search-info" id="result-count"></span>
</div>

<main>
  <div id="articles"></div>
  <div id="pagination" style="display:none">
    <button class="page-btn" id="prev-btn" onclick="changePage(-1)" disabled>← Previous</button>
    <span class="page-info" id="page-info"></span>
    <button class="page-btn" id="next-btn" onclick="changePage(1)">Next →</button>
  </div>
</main>

<div id="modal-overlay" onclick="closeModal()"></div>
<div id="modal" style="display:none">
  <div class="modal-header">
    <div class="modal-source" id="m-source"></div>
    <div class="modal-title" id="m-title"></div>
    <div class="modal-byline">
      <span id="m-meta"></span>
      <button class="close-btn" onclick="closeModal()">✕ Close</button>
    </div>
  </div>
  <div class="modal-body" id="m-body"></div>
</div>

<div id="feed-modal-overlay" onclick="closeFeedModal()"></div>
<div id="feed-modal" style="display:none">
  <div class="feed-modal-header">
    <img class="feed-modal-logo" id="fm-logo" src="" alt="" onerror="this.style.display='none'">
    <div class="feed-modal-name" id="fm-name"></div>
    <button class="feed-modal-close" onclick="closeFeedModal()">✕</button>
  </div>
  <div class="feed-modal-body" id="fm-body"></div>
</div>

<script>
  const LIMIT = 20;
  let currentOffset = 0;
  let currentQuery = '';
  let totalLoaded = 0;
  let hasMore = true;

  // Set date
  document.getElementById('today-date').textContent = new Date().toLocaleDateString('en-US', {
    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
  });

  // Search on enter
  document.getElementById('search-input').addEventListener('keydown', e => {
    if (e.key === 'Enter') doSearch();
  });

  function doSearch() {
    currentQuery = document.getElementById('search-input').value.trim();
    currentOffset = 0;
    fetchArticles();
  }

  async function fetchArticles() {
    const container = document.getElementById('articles');
    container.innerHTML = '<div class="spinner"></div>';
    document.getElementById('pagination').style.display = 'none';
    document.getElementById('result-count').textContent = '';

    let url = `/items?limit=${LIMIT}&offset=${currentOffset}`;
    if (currentQuery) url += `&q=${encodeURIComponent(currentQuery)}`;

    try {
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      renderArticles(data);
    } catch (err) {
      container.innerHTML = `<div class="state-msg">Could not load articles.<span class="mono">${err.message}</span></div>`;
    }
  }

  function renderArticles(items) {
    const container = document.getElementById('articles');
    container.innerHTML = '';

    if (!items || items.length === 0) {
      container.innerHTML = `<div class="state-msg">No articles found.<span class="mono">${currentQuery ? 'Try a different search.' : ''}</span></div>`;
      return;
    }

    totalLoaded = items.length;
    hasMore = items.length === LIMIT;

    document.getElementById('result-count').textContent =
      currentQuery ? `${items.length} result${items.length !== 1 ? 's' : ''} for "${currentQuery}"` : `${items.length} articles`;

    items.forEach((item, i) => {
      const card = document.createElement('div');
      card.className = 'article-card';
      card.style.animationDelay = `${i * 0.04}s`;

      const source = item.feed?.name || new URL(item.url).hostname.replace('www.', '');
      const date = item.published ? formatDate(item.published) : '';
      const desc = item.description ? stripHtml(item.description).slice(0, 180) : '';

      const thumbImg = item.image || item.feed?.image || null;
      const thumbHtml = thumbImg
        ? (item.image
            ? `<img class="card-thumb" src="${esc(item.image)}" alt="" loading="lazy" onerror="this.style.display='none'">`
            : `<div class="card-feed-thumb"><img src="${esc(item.feed.image)}" alt="" loading="lazy" onerror="this.parentElement.style.display='none'"></div>`)
        : '';

      const feedLogoHtml = item.feed?.image
        ? `<img class="card-source-logo" src="${esc(item.feed.image)}" alt="" onerror="this.remove()">`
        : '';

      card.innerHTML = `
        <div class="card-left">
          <div class="card-source">
            <button class="card-source-btn">${feedLogoHtml}${esc(source)}</button>
          </div>
          <div class="card-title">${esc(item.title || 'Untitled')}</div>
          ${desc ? `<div class="card-desc">${esc(desc)}</div>` : ''}
          ${item.author ? `<div class="card-meta">By ${esc(item.author)}</div>` : ''}
        </div>
        <div class="card-right">
          ${thumbHtml}
          <div class="card-date">${date}</div>
        </div>
      `;

      card.addEventListener('click', () => openModal(item));
      card.querySelector('.card-source-btn')?.addEventListener('click', e => {
        e.stopPropagation();
        openFeedModal(item.feed);
      });
      container.appendChild(card);
    });

    // Pagination
    const pg = document.getElementById('pagination');
    pg.style.display = 'flex';
    document.getElementById('prev-btn').disabled = currentOffset === 0;
    document.getElementById('next-btn').disabled = !hasMore;
    const page = Math.floor(currentOffset / LIMIT) + 1;
    document.getElementById('page-info').textContent = `Page ${page}`;
  }

  function openModal(item) {
    const source = item.feed?.name || new URL(item.url).hostname.replace('www.', '');
    const date = item.published ? formatDate(item.published) : '';

    const mSourceEl = document.getElementById('m-source');
    const mFeedLogo = item.feed?.image
      ? `<img class="modal-source-logo" src="${esc(item.feed.image)}" alt="" onerror="this.remove()">`
      : '';
    mSourceEl.innerHTML = `<button class="modal-source-btn" onclick="">${mFeedLogo}${esc(source)}</button>`;
    mSourceEl.querySelector('.modal-source-btn').addEventListener('click', () => {
      closeModal();
      if (item.feed) openFeedModal(item.feed);
    });
    document.getElementById('m-title').textContent = item.title || 'Untitled';

    const meta = [item.author ? `By ${item.author}` : '', date].filter(Boolean).join(' · ');
    document.getElementById('m-meta').textContent = meta;

    const bodyEl = document.getElementById('m-body');
    // Hero image
    const heroSrc = item.image || item.feed?.image || null;
    let html = heroSrc
      ? `<img class="modal-image" src="${esc(heroSrc)}" alt="" onerror="this.remove()">`
      : '';

    if (item.content && item.content.trim()) {
      html += `<div class="modal-content-body">${sanitize(item.content)}</div>`;
    } else if (item.description) {
      html += `<div class="modal-content-body"><p>${esc(item.description)}</p></div>`;
    } else {
      html += `<div class="modal-content-body"><p><em>No content available.</em></p></div>`;
    }

    html += `<div class="modal-content-body" style="padding-top:0"><a class="modal-link" href="${esc(item.url)}" target="_blank" rel="noopener">Read full article →</a></div>`;
    bodyEl.innerHTML = html;

    document.getElementById('modal-overlay').style.display = 'block';
    document.getElementById('modal').style.display = 'block';
    document.getElementById('modal').scrollTop = 0;
    document.body.style.overflow = 'hidden';
  }

  function closeModal() {
    document.getElementById('modal-overlay').style.display = 'none';
    document.getElementById('modal').style.display = 'none';
    document.body.style.overflow = '';
  }

  function closeFeedModal() {
    document.getElementById('feed-modal-overlay').style.display = 'none';
    document.getElementById('feed-modal').style.display = 'none';
    document.body.style.overflow = '';
  }

  function openFeedModal(feed) {
    const logo = document.getElementById('fm-logo');
    if (feed.image) { logo.src = feed.image; logo.style.display = ''; }
    else { logo.style.display = 'none'; }

    document.getElementById('fm-name').textContent = feed.name || 'Unknown Feed';

    const stats = [
      ['Feed URL', feed.feedUrl ? `<a href="${esc(feed.feedUrl)}" target="_blank" rel="noopener">${esc(feed.feedUrl)}</a>` : '—'],
      ['Home', feed.link ? `<a href="${esc(feed.link)}" target="_blank" rel="noopener">${esc(feed.link)}</a>` : (feed.homeUrl ? `<a href="${esc(feed.homeUrl)}" target="_blank" rel="noopener">${esc(feed.homeUrl)}</a>` : '—')],
      ['Last fetched', feed.lastFetched ? formatDateTime(feed.lastFetched) : '—'],
      ['Next fetch', feed.nextFetchAt ? formatDateTime(feed.nextFetchAt) : '—'],
      ['Last published', feed.lastPublished ? formatDateTime(feed.lastPublished) : '—'],
      ['Publish rate', feed.publishRatePerHour != null ? `${feed.publishRatePerHour.toFixed(2)} articles/hr` : '—'],
    ];

    document.getElementById('fm-body').innerHTML = stats.map(([label, value]) => `
      <div class="feed-stat">
        <span class="feed-stat-label">${label}</span>
        <span class="feed-stat-value">${value}</span>
      </div>
    `).join('');

    document.getElementById('feed-modal-overlay').style.display = 'block';
    document.getElementById('feed-modal').style.display = 'block';
    document.body.style.overflow = 'hidden';
  }

  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') { closeModal(); closeFeedModal(); }
  });

  function formatDateTime(iso) {
    try {
      return new Date(iso).toLocaleString('en-US', {
        month: 'short', day: 'numeric', year: 'numeric',
        hour: 'numeric', minute: '2-digit'
      });
    } catch { return iso; }
  }

  function changePage(dir) {
    currentOffset = Math.max(0, currentOffset + dir * LIMIT);
    fetchArticles();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function formatDate(iso) {
    try {
      const d = new Date(iso);
      return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    } catch { return ''; }
  }

  function stripHtml(html) {
    const tmp = document.createElement('div');
    tmp.innerHTML = html;
    return tmp.textContent || tmp.innerText || '';
  }

  function esc(s) {
    return String(s || '')
      .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;');
  }

  // Basic sanitizer: strip scripts, keep safe tags
  function sanitize(html) {
    const div = document.createElement('div');
    div.innerHTML = html;
    div.querySelectorAll('script,style,iframe,form,input,button').forEach(el => el.remove());
    // Make all links open in new tab
    div.querySelectorAll('a').forEach(a => {
      a.setAttribute('target', '_blank');
      a.setAttribute('rel', 'noopener');
    });
    return div.innerHTML;
  }

  // Initial load
  fetchArticles();
</script>
</body>
</html>